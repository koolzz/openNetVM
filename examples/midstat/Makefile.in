# can ping node1 to node3 successfully but wget failed
TARGET = flow_pub_mos
ONVM=1
MOSPATH=/users/weicuidi/onvm-mos
######################################################################
# GCC and compilation options
######################################################################
GCC = $(CC)
GCC_OPT = -m64 -Wall -Werror -fgnu89-inline
GCC_OPT += -DNDEBUG -O3 -g -DNETSTAT -DINFO -DDBGERR -DDBGCERR
GCC_OPT += $(DBG_OPT)
ifeq ($V,) # no echo
    export MSG=@echo
    export HIDE=@
else
    export MSG=@\#
    export HIDE=
endif

######################################################################
# LIBRARIES AND INCLUDES
######################################################################
MTCP_FLD    = $(MOSPATH)/core
MTCP_INC    =-I$(MTCP_FLD)/include
MTCP_TARGET = $(MTCP_FLD)/lib/libmtcp.a
LIBS        += -lmtcp -lssl -lcrypto -lnuma -lpthread -lrt
LIB_DIR     += -L$(MTCP_FLD)/lib
CMN_DIR     = $(MOSPATH)/samples/common
CMN_INC     = -I$(CMN_DIR)
UTIL_INC    = -I$(MOSPATH)/util/include

# I/O library parameter (PSIO or DPDK)
__IO_LIB_ARGS

ifeq ($(ONVM),1)
ifeq ($(RTE_TARGET),)
$(error "Please define RTE_SDK environment variable")
endif
ONVMPATH=/users/weicuidi/openNetVM
INC += -DENABLE_ONVM
ONVM_INC += -I$(ONVMPATH)/onvm/onvm_nflib
ONVM_INC += -I$(ONVMPATH)/onvm/lib
LIBS += ${ONVM_INC}
LIBS += $(ONVMPATH)/onvm/onvm_nflib/$(RTE_TARGET)/libonvm.a
LIBS += $(ONVMPATH)/onvm/lib/$(RTE_TARGET)/libonvmhelper.a -lm
endif
######################################################################

#solve the issues that cannot find rte_common.h when making rte
DPDKPATH=/users/weicuidi/onvm-mos/drivers
DPDK_INC=$(DPDKPATH)/dpdk/include
DPDK_LIB=$(DPDKPATH)/dpdk/lib
DPDK_MACHINE_FLAGS = $(shell cat $(DPDK_INC)/cflags.txt)
INC += ${DPDK_MACHINE_FLAGS} -I${DPDK_INC} -include $(DPDK_INC)/rte_config.h
LIBS += -export-dynamic -L$(DPDK_LIB)
LIBS += -export-dynamic -L$(DPDK_INC)
#######################################################################

default: $(TARGET)

$(MTCP_TARGET):
	cd $(MTCP_FLD)/src && make	

$(TARGET): $(MTCP_TARGET) $(TARGET).c $(CMN_DIR)/*.c
	$(MSG) "   CC $<"
	$(HIDE) $(GCC) $(GCC_OPT) -o $@ $^ $(MTCP_INC) $(CMN_INC) $(UTIL_INC) $(LIB_DIR) $(LIBS) $(INC)

clean:
	rm -rf *~ *.o $(TARGET) logs/*

cleanall: clean
	rm -rf Makefile


